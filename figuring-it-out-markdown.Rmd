---
title: "TrainTracker: Predicting New Jersey Transit Delays & Unifying Transit Information"
author: "Trevor Kapuvari & Timothy Oliver"
date: "15 December 2023"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: hide
---

# Motivation

Trains are a timeless mode of transportation that has revolutionized the world. As we aim to improve their reliability and accessibility, it is crucial to understand their performance records and allow riders to stay informed on travel updates, train reliability, and enable them to plan their trips accordingly. Hence, we have dedicated this brief to developing a two-part prediction model to forecast train delays. 

This analysis serves as an experimental use-case that can be replicated to other transit regions in the United States and further enable inter-state travels to efficiently utilize train networks. 

```{r clear_environment, include=F, results = 'hide'}
rm(list=ls())
```


```{r setup, include=FALSE}

# global options for knitting chunks
local({
  hook_output <- knitr::knit_hooks$get('output')
  knitr::knit_hooks$set(output = function(x, options) {
    if (!is.null(options$max.height)) options$attr.output <- c(
      options$attr.output,
      sprintf('style="max-height: %s;"', options$max.height)
    )
    hook_output(x, options)
  })
})
knitr::opts_chunk$set(echo = TRUE,message=F,warning=F)



library(summarytools)
library(stargazer)
library(vtable)
library(tidyverse)
library(tidycensus)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) # plot correlation plot
library(corrr)      # another way to plot correlation plot
library(kableExtra)
library(jtools)     # for regression model plots
library(ggstance) # to support jtools plots
library(ggpubr)    # plotting R^2 value on ggplot point scatter
library(broom.mixed) # needed for effects plots
library(tufte)
library(viridis)
library(RSocrata)
library(classInt)
library(spatstat)
library(pscl)
library(plotROC)
library(pROC)
library(lubridate)
library(ROSE)
library(tigris)
library(knitr)
library(RSocrata)


# functions and data directory
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"


source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
source("themes/plotTheme_TO.r")
# source("functions/quantileBreaks.r")

palette2 <- c("#981FAC","#FF006A")
palette5 <- c("#25CB10", "#5AB60C", "#8FA108",   "#C48C04", "#FA7800")
palette5a <- c("#eff3ff","#bdd7e7","#6baed6","#3182bd","#08519c")
palette4a <- c("#D2FBD4","#92BCAB","#527D82","#123F5A")
palette2a <- c("#6baed6","#08519c")

palette9 <- viridis(9)

options(scipen=999)

```

# Data Sources

Our initial dataset is derived from Kaggle's NJ Transit & Amtrak Rail Performance. Due to the high volume of data, we narrowed the scope of the model to focus on April & May 2020. The data features Amtrak trains between New York & New Jersey, as well as recording lines from NJ Transit. This sample provides insight on performance at peak train-use because the Northeast Corridor, the main rail studied, is considered the busiest passenger rail line in the United States. Within the data we are able to explore the individual train's scheduled time, actual time, planned stations, and sequence in train line over the course of two months. That information allows our model to predict a delay based on its past performance and time of the week/day to detect any temporal patterns that may exist. 


Source: https://www.kaggle.com/datasets/pranavbadami/nj-transit-amtrak-nec-performance


```{r kaggle_data, results='hide'}
if (!dir.exists("data/Kaggle_transit&amtrak_data/")){
unzip("data/Kaggle_transit&amtrak_data.zip",exdir="data/Kaggle_transit&amtrak_data")
}

datApr2020 <- read.csv("data/Kaggle_transit&amtrak_data/2020_04.csv")
datMay2020 <- read.csv("data/Kaggle_transit&amtrak_data/2020_05.csv")


datApr2020 <- datApr2020 %>%
  mutate(interval60 = floor_date(ymd_hms(scheduled_time), unit = "hour"),
         interval15 = floor_date(ymd_hms(scheduled_time), unit = "15 mins"),
         interval1 = floor_date(ymd_hms(scheduled_time), unit = "min"),
         week = week(interval60),
         dotw = wday(interval60,label=T),
         delayed = ifelse(delay_minutes > 0,TRUE,FALSE))

datMay2020 <- datMay2020 %>%
  mutate(interval60 = floor_date(ymd_hms(scheduled_time), unit = "hour"),
         interval15 = floor_date(ymd_hms(scheduled_time), unit = "15 mins"),
         interval1 = floor_date(ymd_hms(scheduled_time), unit = "min"),
         week = week(interval60),
         dotw = wday(interval60,label=T),
         delayed = ifelse(delay_minutes > 0,TRUE,FALSE))

nj_trans_stations <- st_read("data/Rail_Stations_of_NJ_Transit.geojson")%>% st_transform(crs="ESRI:102711")

nj_trans_lines <- st_read("data/Rail_Lines_of_NJ_Transit.geojson")%>% st_transform(crs="ESRI:102711")


may_w_stations <- merge(x= nj_trans_stations,y=datMay2020,by.x="STATION_ID",by.y="from")%>%
  rename(from_station = STATION_ID,
         fromLat = LATITUDE, fromLon = LONGITUDE, 
         from_atis_id = ATIS_ID, from_muni = MUNICIPALITY,
         from_rail_service = RAIL_SERVICE)%>%
  select(-OBJECTID_1,-LINE_CODE)%>%
  st_drop_geometry()%>%
  merge(y=nj_trans_stations,by.x="to",by.y="STATION_ID")%>%
  rename(toLat = LATITUDE, toLon = LONGITUDE, 
         to_atis_id = ATIS_ID, to_muni = MUNICIPALITY,
         to_rail_service = RAIL_SERVICE) %>%
  select(-OBJECTID_1)%>%
  st_drop_geometry() %>%
  merge(y=nj_trans_lines,by="LINE_CODE")%>%
  select(-OBJECTID)%>%
  st_drop_geometry()
  
```

Additional data from the American Community Survey (ACS) provided us insight on commuter data for New York, New Jersey, and Pennsylvania area. The data provided here us the sense of urgency and importance these rail lines are to commuters. Areas surrounding New York City greatly rely on trains and public transit for commuting or everyday travel. 

```{r wrangling, results='hide'}
census <- 
  get_acs(geography = "county", 
          variables = c("B01003_001", "B19013_001", 
                        "B02001_002", "B08013_001",
                        "B08012_001", "B08301_001", 
                        "B08301_010", "B01002_001"), 
          year = 2021, 
          geometry = TRUE, 
          output = "wide") %>%
  rename(Total_Pop =  B01003_001E,
         Med_Inc = B19013_001E,
         Med_Age = B01002_001E,
         White_Pop = B02001_002E,
         Travel_Time = B08013_001E,
         Num_Commuters = B08012_001E,
         Means_of_Transport = B08301_001E,
         Total_Public_Trans = B08301_010E)%>%
  st_transform(crs="EPSG:4326")

tracts <- 
  get_acs(geography = "tract", 
          variables = c("B01003_001", "B19013_001", 
                        "B02001_002", "B08013_001",
                        "B08012_001", "B08301_001", 
                        "B08301_010", "B01002_001"), 
          year = 2021, 
          geometry = TRUE,
          state="NJ",
          output = "wide") %>%
  rename(Total_Pop =  B01003_001E,
         Med_Inc = B19013_001E,
         Med_Age = B01002_001E,
         White_Pop = B02001_002E,
         Travel_Time = B08013_001E,
         Num_Commuters = B08012_001E,
         Means_of_Transport = B08301_001E,
         Total_Public_Trans = B08301_010E)%>%
  st_transform(crs="EPSG:4326")

threeStates = census%>%filter(grepl("New Jersey",NAME)|grepl("Pennsylvania",NAME)|grepl("New York",NAME))
nj = census%>%filter(grepl("New Jersey",NAME))

```

# Means of Transport 

This maps indicates the importance of using NYC and NJ Transit as our initial case-study area for our model. Commuting by train is underused in most areas of the country especially when distant from any major cities. New Jersey has a special case of being between two major metropolitan areas, New York and Philadelphia. This location makes the State optimal for long-distance train studies. Even when the majority of New York State and Pennsylvania are more blue, showing lower numbers of commuters, New Jersey's roughly purple palette proves the importance of trains in the regional economy. 

```{r ThreeState Commuters by Rail}

ggplot()+
  geom_sf(data=threeStates,aes(fill = Means_of_Transport))+
  labs(title = "Daily Passenger Train Commuters", fill = "Average Daily Commuters by Rail")+
  scale_y_continuous(labels = scales::comma_format())+ #why not comma separation wtf 
  scale_fill_gradient(low = "royalblue", high = "red")+ 
  plotTheme()+
  theme(panel.background=element_rect(
        fill = "#fcfcf4",
        colour = NA),
        panel.grid.major=element_blank(),
        axis.text=element_blank())


```



```{r census_join}
may_census <- st_join(may_w_stations %>% 
          filter(is.na(fromLon) == FALSE &
                   is.na(fromLat) == FALSE &
                   is.na(toLon) == FALSE &
                   is.na(toLat) == FALSE) %>%
          st_as_sf(., coords = c("fromLon", "fromLat"), crs = 4326),
        threeStates %>%
          st_transform(crs=4326),
        join=st_intersects,
              left = TRUE) %>%
  rename(Origin.County = GEOID) %>%
  mutate(fromCountyLon = unlist(map(geometry, 1)),
         fromCountyLat = unlist(map(geometry, 2)))%>%
  as.data.frame() %>%
  select(-geometry)%>%
  st_as_sf(., coords = c("toLon", "toLat"), crs = 4326) %>%
  st_join(., threeStates %>%
            st_transform(crs=4326),
          join=st_intersects,
          left = TRUE) %>%
  rename(Destination.County = GEOID)  %>%
  mutate(toCountyLon = unlist(map(geometry, 1)),
         toCountyLat = unlist(map(geometry, 2)))%>%
  as.data.frame() %>%
  select(-geometry)
```


# New Jersey Transit Map

The map below depicts New Jersey Transit lines that we predicted delays for in the model. Predictions within the model ranged between 1 minute to almost 2 hours, for the purpose of the analysis and due to available data, we are focusing our attention of these lines. 

```{r view_stations}

ggplot()+
  geom_sf(data=nj%>%st_transform(st_crs(nj_trans_stations)),color = "white",fill="darkgray")+
  geom_sf(data=nj_trans_stations, color="black")+
  geom_sf(data=nj_trans_lines,aes(color = LINE_NAME))+
  labs(title = "New Jersey Transit Map", color = "Train Line")+
  plotTheme()+
  theme(panel.background=element_rect(
        fill = "#fcfcf4",
        colour = NA),
        panel.grid.major=element_blank(),
        axis.text=element_blank())


```

# Exploratory Analysis

## Temporal Train Cycle 

The graph below shows a temporal cycle of train trips by NJ Transit. One important factor when accounting for delays, whether the cause or the effects, is the time of day. The pattern between peak hours and when there are few trains can assist the model in detecting patterns in delays caused by time, and how greatly that effects the probability or length of the delay. 

```{r plots}

ggplot(may_w_stations %>%
         group_by(interval60) %>%
         tally())+
  geom_line(aes(x = interval60, y = n))+
  labs(title="Train Trips in NYC Area (NJ Transit), May 2020",
       x="Date", 
       y="Number of Trips")+
  plotTheme()+
  coord_cartesian(ylim=c(0,300))




```
## Delay Count

The value of trains to the region also is rooted in their reliability and people's understanding of such. Out of the 70,000  recorded stops, there were roughly 52,000  of which that were delayed in some capacity. That is 70% of all trips. This graph records all delays regardless of severity, but still means there was higher likelihood or a commuter's trip being delayed than not. It is important to understand some delays recorded were negligible (less than 10 minutes), yet others were almost 2 hours. This information is what riders would find useful before it occurs, especially before arriving to their train station.  

**Note: All `r length(datMay2020[datMay2020$type=="Amtrak",]$interval60)` of Amtrak's records in the full May data have no scheduled time and thereby no interval. The merged data has `r length(may_w_stations[may_w_stations$type=="Amtrak",]$interval60)` such NA records**

```{r bar plot}

ggplot(may_w_stations,mapping=aes(x=delayed))+
  geom_bar(aes(fill=delayed,show.legend=F))+
  geom_text(aes(label=..count..),stat="count",color="white",vjust=1.5)+
  labs(title="Delayed Train Trip Count for NJ Transit, May 2020",
       y="Number of trips",
       x = "Delayed")+
  guides(fill=guide_legend(title = "Delayed Train?"))+
  scale_color_manual(labels=c("False","True","Amtrak"),
                     values = c(GRAY9,BLUE3,GREEN3) # did nothing?
                     )+
  plotTheme()+
  theme(panel.border = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.y = element_blank())



```


## Tracking Station Business 

Graph below shows that majority of stations each day only saw one or two train stops every hour. This frequency seen at majority of stations indicates a level of importance the timing these trains have in terms of efficiency. Large delays for stops that do not have multiple trains can result in riders having few to no alternative route options and must succumb to the lateness brought by delays. Places that see more trains are also jeopardized by delays for different reasons, delays, if large enough, can create rail congestion and in turn cause delays for other trains that would have otherwise been timely. 

```{r from_station}
ggplot(may_w_stations %>%
         group_by(interval60, from_station) %>%
         tally())+
  geom_histogram(aes(n), binwidth = 1, color = GRAY8)+
  labs(title="Train Trips per Hour. NJ Transit & Amtrak Area, May 2020",
       x="Trip Counts", 
       y="Number of Stops")+
  plotTheme()+
  coord_cartesian(xlim=c(0,10))
```

```{r probability of delay attempt}
delayprobability <- datMay2020 %>%
  mutate(delay_prob = delay_minutes * 0)

delayprobability <- glm(delay_prob ~ .,
                     data = delayprobability %>% select(date, train_id, stop_sequence, from_id, to_id, delay_minutes, week),
                     family="binomial" (link="logit"))

```


### panel 


```{r panel}
length(unique(may_w_stations$interval60)) * length(unique(may_w_stations$from_id))


study.panel <- 
  expand.grid(interval60=unique(may_w_stations$interval60), 
              from_id = unique(may_w_stations$from_id)) %>%
  left_join(., may_census %>%
              # changed fromLon & Lat to fromCountyLon & Lat
              select(train_id, from_id, from_station, fromCountyLon, fromCountyLat,line,delay_minutes)%>% # Origin.Tract,
              distinct() %>%
              group_by(from_id) %>%
              slice(1))

nrow(study.panel)   
```

```{r geometry_in_panel}
ride.panel <- may_census %>%
  mutate(Trip_Counter = 1) %>%
  right_join(study.panel) %>% 
  # changed fromLon & Lat to fromCountyLon & Lat
  group_by(interval60, from_id, from_station, Origin.County, fromCountyLon, fromCountyLat,delay_minutes) %>%
  summarize(Trip_Count = sum(Trip_Counter, na.rm=T)) %>%
  ungroup() %>%
  filter(is.na(from_id) == FALSE) %>%
  mutate(week = week(interval60),
         dotw = wday(interval60, label = TRUE)) %>%
  filter(is.na(Origin.County) == FALSE) %>%
  # left_join(study.panel, threeStates %>%
  #             as.data.frame()) %>% # extra parenthesis
              # select(-geometry), by = c("Origin.Tract" = "GEOID")) %>%
  arrange(from_id, interval60) %>% 
  mutate(lagHour = dplyr::lag(delay_minutes,1),
         lag2Hours = dplyr::lag(delay_minutes,2),
         lag3Hours = dplyr::lag(delay_minutes,3),
         lag4Hours = dplyr::lag(delay_minutes,4),
         lag12Hours = dplyr::lag(delay_minutes,12),
         lag1day = dplyr::lag(delay_minutes,24)) %>%
         # # Indigenous Peoples' (Columbus) Day is federally recognized
         # #  but not an official city holiday of Austin
         # ## I include it to account for holiday lag
         # holiday = ifelse(yday(interval60) == 282,1,0)) %>%
   mutate(day = yday(interval60)) # %>%
   # mutate(holidayLag = case_when(dplyr::lag(holiday, 1) == 1 ~ "PlusOneDay",
   #                               dplyr::lag(holiday, 2) == 1 ~ "PlusTwoDays",
   #                               dplyr::lag(holiday, 3) == 1 ~ "PlusThreeDays",
   #                               dplyr::lead(holiday, 1) == 1 ~ "MinusOneDay",
   #                               dplyr::lead(holiday, 2) == 1 ~ "MinusTwoDays",
   #                               dplyr::lead(holiday, 3) == 1 ~ "MinusThreeDays"),
   #       holidayLag = ifelse(is.na(holidayLag) == TRUE, 0, holidayLag))

```

### get lines and visualize reliability

### timelapse of reliability (week)

### add in the envelope of time delay (sd in prediction)
